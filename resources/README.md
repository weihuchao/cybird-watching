# 资源配置说明

## 配置文件格式

小鸟配置使用CSV格式（`bird_config.csv`），包含以下字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | 数字 | 小鸟的唯一标识符（1001-65535） |
| `name` | 文本 | 小鸟的显示名称（支持中文） |
| `weight` | 数字 | 权重值，影响随机选择的概率（1-65535，越大越容易被选中） |

### CSV文件示例

```csv
id, name, weight
1001,普通翠鸟,50
1002,白胸翡翠,50
1003,冠鱼狗,20
```

## 资源目录结构

系统使用**Bundle模式**，每只小鸟的所有帧数据打包在单个二进制文件中：

```
/
├── configs/
│   └── bird_config.csv      # 小鸟配置文件
├── birds/
│   ├── 1001/
│   │   └── bundle.bin       # 小鸟1001的所有帧（Bundle格式）
│   ├── 1002/
│   │   └── bundle.bin       # 小鸟1002的所有帧（Bundle格式）
│   └── ...
└── static/
    └── logo.bin             # 系统Logo图片
```

## Bundle文件格式

Bundle文件（`bundle.bin`）是自定义的二进制格式，包含：

### 文件头 (64字节)
- **Magic**: `0x42495244` ("BIRD")
- **Version**: 版本号（当前为1）
- **Frame Count**: 总帧数（最大65535）
- **Frame Size**: 单帧大小（120×120×2 + LVGL头）
- **Color Format**: `0x12` (RGB565)
- 其他元数据...

### 帧索引表 (12字节×帧数)
每个帧的索引条目包含：
- 帧数据偏移量
- 帧数据大小
- CRC32校验和（可选）

### 帧数据区
所有帧的RGB565图像数据（包含LVGL图像描述符）

## 配置说明

1. **ID与目录对应**: 配置中的`id`字段必须与`/birds/`下的目录名完全一致
2. **Bundle生成**: 使用项目提供的`mp4converter`脚本将视频转换为bundle文件
3. **自动检测帧数**: 系统启动时会从bundle文件头自动读取帧数（O(1)复杂度）
4. **支持任意帧数**: 理论支持最多65535帧，实际受SD卡容量限制
5. **播放帧率**: 当前为15 FPS（66ms/帧），优化了流畅度和看门狗安全性

## 权重系统

权重影响小鸟被随机选中的概率：

- **总权重** = 所有小鸟权重之和
- **选中概率** = 该鸟权重 / 总权重 × 100%

**示例**：
- 普通翠鸟(50) + 白胸翡翠(50) + 冠鱼狗(20) = 总权重120
- 普通翠鸟选中概率：50/120 = 41.7%
- 白胸翡翠选中概率：50/120 = 41.7%
- 冠鱼狗选中概率：20/120 = 16.7%

**建议**：
- 常见鸟类：50-100
- 较少见鸟类：20-50
- 稀有鸟类：5-20

## 使用方法

### 1. 准备配置文件
将`bird_config.csv`复制到SD卡的`/configs/`目录下

### 2. 生成Bundle资源
使用项目的`mp4converter`工具转换视频：

```bash
cd scripts/mp4converter
python -m mp4converter input.mp4 --bird-id 1001
```

生成的`bundle.bin`将自动放置在`resources/birds/1001/`目录

### 3. 部署到SD卡
将整个`birds/`目录复制到SD卡根目录

### 4. 启动系统
- 插入SD卡到设备
- 系统启动时自动扫描并加载所有小鸟资源
- 加载过程会显示每只小鸟的帧数检测进度

## 技术特性

- ✅ **高效加载**: Bundle模式减少SD卡文件操作次数
- ✅ **快速启动**: O(1)时间复杂度检测帧数
- ✅ **大容量支持**: 单只鸟最多支持65535帧
- ✅ **内存优化**: 按需加载帧数据，无需全部加载到内存
- ✅ **数据完整性**: 支持CRC32校验（可选）
- ✅ **跨平台**: 与Python端`rgb565.py`格式完全兼容

## 故障排查

### 配置加载失败
- 检查CSV文件路径：`/configs/bird_config.csv`
- 检查CSV格式：确保使用逗号分隔，首行为标题
- 检查字段完整性：id、name、weight缺一不可

### Bundle加载失败
- 检查文件路径：`/birds/{id}/bundle.bin`
- 检查Magic值：应为`0x42495244`
- 检查版本号：当前仅支持version=1
- 使用最新版`mp4converter`重新生成

### 播放卡顿
- 降低视频帧数（建议≤200帧）
- 检查SD卡速度（建议Class 10或以上）
- 检查帧尺寸是否为120×120

## 参考资源

- 配置文件：`resources/configs/bird_config.csv`
- 视频转换工具：`scripts/mp4converter/`
- Bundle格式定义：`src/applications/modules/bird_watching/core/bird_bundle_loader.h`